name: Build Velix

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

env:
  CMAKE_VERSION: 3.31.6

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      - name: Verify and Update Submodules
        run: |
          git submodule update --init --recursive
          git submodule status
          ls -la external/

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential libgl1-mesa-dev ninja-build libvulkan-dev vulkan-tools
          sudo apt install -y libwayland-dev wayland-protocols extra-cmake-modules
          sudo apt install -y libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev
          sudo apt install -y libxkbcommon-dev
          sudo apt install -y pkg-config

      - name: Download Portable CMake (Linux)
        run: |
          set -euo pipefail
          CMAKE_ROOT="$GITHUB_WORKSPACE/bundled/cmake"
          ARCHIVE_NAME="cmake-${CMAKE_VERSION}-linux-x86_64.tar.gz"
          DOWNLOAD_URL="https://github.com/Kitware/CMake/releases/download/v${CMAKE_VERSION}/${ARCHIVE_NAME}"
          TMP_ARCHIVE="$RUNNER_TEMP/${ARCHIVE_NAME}"
          TMP_EXTRACT="$RUNNER_TEMP/cmake-${CMAKE_VERSION}-linux-x86_64"

          mkdir -p "$CMAKE_ROOT"
          curl -L --retry 5 --retry-all-errors --output "$TMP_ARCHIVE" "$DOWNLOAD_URL"
          rm -rf "$TMP_EXTRACT"
          tar -xzf "$TMP_ARCHIVE" -C "$RUNNER_TEMP"
          cp -a "$TMP_EXTRACT/." "$CMAKE_ROOT/"

          echo "$CMAKE_ROOT/bin" >> "$GITHUB_PATH"
          echo "VELIX_BUNDLED_CMAKE_DIR=$CMAKE_ROOT" >> "$GITHUB_ENV"

      - name: Configure and Build
        run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DPHYSX_BUILD_TYPE=checked -DVELIX_BUNDLED_CMAKE_DIR="$VELIX_BUNDLED_CMAKE_DIR" && cmake --build build
      
      - name: Install to Staging Dir
        run: |
          mkdir -p build/lib
          cmake --install build --prefix staging/Velix

      - name: SDK Smoke Test (Template Module)
        run: |
          rm -rf /tmp/velix-template-smoke
          mkdir -p /tmp/velix-template-smoke
          cp -r resources/projectTemplate/* /tmp/velix-template-smoke/
          cmake -S /tmp/velix-template-smoke -B /tmp/velix-template-smoke/build -DCMAKE_PREFIX_PATH="$GITHUB_WORKSPACE/staging/Velix"
          cmake --build /tmp/velix-template-smoke/build

      - name: Create Archive
        run: |
          tar -czvf Velix-linux.tar.gz -C staging Velix

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Velix-linux
          path: Velix-linux.tar.gz

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      - name: Verify and Update Submodules
        run: |
          git submodule update --init --recursive
          git submodule status

      - name: Install Vulkan SDK
        run: |
          curl -Lo vulkan-sdk.exe https://sdk.lunarg.com/sdk/download/latest/windows/vulkan-sdk.exe
          ./vulkan-sdk.exe --accept-licenses --default-answer --confirm-command install
          $sdkPath = Get-ChildItem "C:\VulkanSDK" -Directory | Select-Object -Last 1 -ExpandProperty FullName
          echo "VULKAN_SDK=$sdkPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          echo "VULKAN_SDK is set to: $sdkPath"

      - name: Setup MSVC Developer Environment
        uses: ilammy/msvc-dev-cmd@v1

      - name: Download Portable CMake (Windows)
        shell: pwsh
        run: |
          $cmakeRoot = Join-Path $env:GITHUB_WORKSPACE "bundled/cmake"
          $archiveName = "cmake-$env:CMAKE_VERSION-windows-x86_64.zip"
          $downloadUrl = "https://github.com/Kitware/CMake/releases/download/v$env:CMAKE_VERSION/$archiveName"
          $archivePath = Join-Path $env:RUNNER_TEMP $archiveName
          $extractDir = Join-Path $env:RUNNER_TEMP "cmake-$env:CMAKE_VERSION-windows-x86_64"

          New-Item -ItemType Directory -Force -Path $cmakeRoot | Out-Null
          if (Test-Path $extractDir) {
            Remove-Item $extractDir -Recurse -Force
          }

          Invoke-WebRequest -Uri $downloadUrl -OutFile $archivePath
          Expand-Archive -Path $archivePath -DestinationPath $env:RUNNER_TEMP -Force
          Copy-Item (Join-Path $extractDir '*') $cmakeRoot -Recurse -Force

          Add-Content -Path $env:GITHUB_PATH -Value (Join-Path $cmakeRoot 'bin')
          Add-Content -Path $env:GITHUB_ENV -Value "VELIX_BUNDLED_CMAKE_DIR=$cmakeRoot"

      - name: Configure and Build
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DPHYSX_BUILD_TYPE=checked -DVulkan_ROOT="$env:VULKAN_SDK" -DVELIX_BUNDLED_CMAKE_DIR="$env:VELIX_BUNDLED_CMAKE_DIR"
          cmake --build build --config Release

      - name: Install to Staging Dir
        run: |
          cmake --install build --prefix staging/Velix

      - name: Copy Vulkan Runtime DLLs
        run: |
            $binDir = "staging/Velix/bin"
            New-Item -ItemType Directory -Force -Path $binDir | Out-Null
            echo "Created directory: $binDir"
            
            $vulkanDll = Get-ChildItem -Path $env:VULKAN_SDK -Recurse -Filter "vulkan-1.dll" | Select-Object -First 1
            if ($vulkanDll) {
                Copy-Item $vulkanDll.FullName $binDir
                echo "Successfully copied vulkan-1.dll from: $($vulkanDll.FullName)"
            } else {
                echo "vulkan-1.dll not found in Vulkan SDK, trying system locations..."
                
                # Try system directories
                $systemDll = $null
                $systemPaths = @(
                    "C:\Windows\System32\vulkan-1.dll",
                    "C:\Windows\SysWOW64\vulkan-1.dll"
                )
                
                foreach ($path in $systemPaths) {
                    if (Test-Path $path) {
                        $systemDll = $path
                        break
                    }
                }
                
                if ($systemDll) {
                    Copy-Item $systemDll $binDir
                    echo "Copied vulkan-1.dll from system location: $systemDll"
                } else {
                    echo "WARNING: vulkan-1.dll not found in any location!"
                    echo "The application may not run without Vulkan runtime installed."
                }
            }
            
            if (Test-Path "$binDir/vulkan-1.dll") {
                echo "SUCCESS: vulkan-1.dll is in the staging directory"
            } else {
                echo "ERROR: vulkan-1.dll was not copied to staging directory"
            }

      - name: Create Archive
        run: |
          tar -czvf Velix-windows.tar.gz -C staging Velix

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Velix-windows
          path: Velix-windows.tar.gz
